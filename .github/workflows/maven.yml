name: Java CI with Maven

on:
  push:
    branches: [ "main", "master", "develop" ]
  pull_request:
    branches: [ "main", "master" ]
  release:
    types: [ published ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ—ï¸ Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: ğŸ”§ Build with Maven
      run: mvn -B clean package --file pom.xml
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“Š Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: ChatSync-JAR
        path: target/*.jar
        retention-days: 30

    - name: ğŸ·ï¸ Get version from POM
      id: get_version
      run: echo "version=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)" >> $GITHUB_OUTPUT

    - name: ğŸš€ Create GitHub Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: target/*.jar
        body: |
          ## ğŸ‰ ChatSync ${{ steps.get_version.outputs.version }}
          
          ### âœ¨ ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµĞ»Ğ¸Ğ· Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ° ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ñ‡Ğ°Ñ‚Ğ° Minecraft-Telegram
          
          **ĞĞ²Ñ‚Ğ¾Ñ€Ñ‹:** gordey9992 & DeepSeek
          
          ### ğŸ“¦ Ğ§Ñ‚Ğ¾ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾:
          - Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‡Ğ°Ñ‚Ğ° Minecraft â†” Telegram
          - ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° EssentialsXChat & EssentialsX
          - ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ñ€ÑƒÑÑĞºĞ°Ñ Ğ»Ğ¾ĞºĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
          - ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ğµ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‹ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
          
          ### ğŸš€ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°:
          1. Ğ¡ĞºĞ°Ñ‡Ğ°Ğ¹Ñ‚Ğµ JAR Ñ„Ğ°Ğ¹Ğ»
          2. ĞŸĞ¾Ğ¼ĞµÑÑ‚Ğ¸Ñ‚Ğµ Ğ² Ğ¿Ğ°Ğ¿ĞºÑƒ `plugins/`
          3. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ `config.yml`
          4. ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚Ğµ ÑĞµÑ€Ğ²ĞµÑ€
          
          ### ğŸ“– Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ:
          - [GitHub Repository](https://github.com/${{ github.repository }})
          - [Config Guide](https://github.com/${{ github.repository }}/blob/main/README.md)

  test:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: ğŸ” Run tests
      run: mvn -B test --file pom.xml

    - name: ğŸ“Š Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: target/surefire-reports/
        retention-days: 7

  quality:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: ğŸ” Checkstyle analysis
      run: mvn -B checkstyle:check --file pom.xml

    - name: ğŸ“ˆ JaCoCo coverage
      run: mvn -B jacoco:prepare-agent test jacoco:report --file pom.xml

    - name: ğŸ“¤ Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: target/site/jacoco/jacoco.xml
        flags: unittests
        name: codecov-umbrella

  deploy:
    runs-on: ubuntu-latest
    needs: [build, test, quality]
    if: github.event_name == 'release'
    
    steps:
    - name: ğŸ“¥ Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: ChatSync-JAR
        path: target/

    - name: ğŸ·ï¸ Get version
      id: get_version
      run: echo "version=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)" >> $GITHUB_OUTPUT

    - name: ğŸ“¦ Prepare deployment
      run: |
        mkdir -p deployment
        cp target/*.jar deployment/
        echo "ChatSync v${{ steps.get_version.outputs.version }}" > deployment/version.txt
        date > deployment/build_date.txt

    - name: ğŸš€ Deploy to GitHub Pages (Documentation)
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./deployment
        keep_files: false

    - name: ğŸ“¢ Notify Discord
      uses: sarisia/actions-status-discord@v1
      if: always()
      with:
        webhook: ${{ secrets.DISCORD_WEBHOOK }}
        title: "ChatSync Build Complete"
        description: "Build for ${{ github.ref }} completed with status: ${{ job.status }}"
        color: "0x00FF00"
        url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  security:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”’ CodeQL Analysis
      uses: github/codeql-action/init@v2
      with:
        languages: java

    - name: ğŸ” Autobuild
      uses: github/codeql-action/autobuild@v2

    - name: ğŸ“Š Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2

    - name: ğŸ›¡ï¸ Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'ChatSync'
        path: '.'
        format: 'HTML'
        out: 'reports'

    - name: ğŸ“¤ Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: reports/
        retention-days: 30

  notifications:
    runs-on: ubuntu-latest
    needs: [build, test, quality, security]
    if: always()
    
    steps:
    - name: ğŸ“± Notify on failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸš¨ Build Failed for ${context.ref}`,
            body: `Build failed for commit ${context.sha}. Check the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`,
            labels: ['bug', 'ci']
          })
